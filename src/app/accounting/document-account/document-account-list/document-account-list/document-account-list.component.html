<app-spinner *ngIf="spinner" class="spinner"></app-spinner>
<div class="col-lg-12 col-md-12 col-sm-12">
  <div class="row">
    <div class="card">
      <div class="card-content">
        <!--Begin card header-->
        <app-current-fiscal-year-header [currentFiscalYearId]="currentFiscalYear.id"></app-current-fiscal-year-header>
        <div class="card-header d-flex justify-content-between pr-0">
          <div class="col-sm-5 mt-1">
            <h3 class="card-title mb-0">{{'ALL_DOCUMENT_ACCOUNT_LIST'|translate}}</h3>
          </div>
          <div class="col-sm-5 mt-1">
            <app-current-fiscal-year-dropdown [currentFiscalYearId]="currentFiscalYear.id">
            </app-current-fiscal-year-dropdown>
          </div>

        </div>

        <div class="card-body">
          <app-advanced-search [filtreFieldsColumns]="filterFieldsColumns" [filtreFieldsInputs]="filterFieldsInputs"
            (filtrePredicateToSend)="getFilterPredicate($event)" (predicateOperator)="getOperatorPredicate($event)"
            (searchClickEvent)="searchClick()" (resetClickEvent)="resetClickEvent()">
          </app-advanced-search>
          <div class="row mt-2">
            <div class="col-lg-3">
              <form class="form-horizontal" [formGroup]="lineSearchFormGroup">
                <label class="col-lg-12 col-md-12 col-sm-12"> {{'ACCOUNT'|translate}}</label>
                <kendo-combobox formControlName="accountId" [data]="accountFilteredList" [textField]="'code'"
                  [valueField]="'id'" [valuePrimitive]="true" class="form-control" [filterable]="true"
                  (filterChange)="handleFilterAccount($event)"
                  (selectionChange)="selectionChangeAccountDropdown($event)">
                  <ng-template kendoComboBoxItemTemplate let-dataItem>
                    <div class="container">
                      <div class="row">
                        <b>{{dataItem.code}}</b>
                      </div>
                      <div class="row">
                        <span class="small">{{dataItem.label}}</span>
                      </div>
                    </div>
                  </ng-template>
                  <!--No data template-->
                  <ng-template kendoDropDownListNoDataTemplate>
                    <h5><br /> {{'NO_DATA_FOUND'|translate}}</h5>
                  </ng-template>
                  <kendo-combobox-messages clearTitle="{{'CLEAR'|translate}}"> </kendo-combobox-messages>
                  <!--end No data template-->
                </kendo-combobox>
              </form>
            </div>
            <div class="col-lg-3">
              <form class="form-horizontal" [formGroup]="lineSearchFormGroup">
                <label class="col-lg-5 col-md-5 col-sm-5">{{'AMOUNT'|translate}}</label>
                <div class="p-0">
                  <kendo-numerictextbox [format]="formatNumberOptions" class="form-control" name="amount"
                    (blur)="handleSearch()" formControlName="amount"
                    [formControl]="lineSearchFormGroup.get('amount')" appThreeDigitDecimaNumber>
                  </kendo-numerictextbox><br>
                </div>
              </form>
            </div>
            <div class="col-lg-1">
              <div class="mt-4 pt-2">
                  <i class="fa fa-search fa-lg" aria-hidden="true" [tooltip]="searchDA" content-type="template" (click)="initGridDataSource()"></i>
                <ng-template #searchDA>
                  <span>{{ 'SEARCH'|translate}}</span>
                </ng-template>
              </div>
            </div>
          </div>
          <div class="row"
            style="color: #0d35a3;margin-top: 1em;font-size: 11px; padding-left:15px; padding-right:15px">
            NB: {{'DOCUMENT_LINE_FILTER_INFO'|translate}}
          </div>
        </div>
        <!--End card header-->
        <div class="card-body pt-2">
          <kendo-grid [data]="gridSettings.gridData" [pageSize]="gridSettings.state.take" [pageable]="pagerSettings"
            [skip]="gridSettings.state.skip" (dataStateChange)="dataStateChange($event)"
            [sort]="gridSettings.state.sort" [filter]="gridSettings.state.filter" [selectable]="true" [sortable]="true"
            [filterable]="false" [reorderable]="true" (remove)="removeHandler($event)" (sortChange)="sortChange()"
            (filterChange)="filterChange()" (pageChange)="onPageChange()" style="width: 100%;margin-top: -2em;">


            <!--Grid Toolbar-->
            <ng-template kendoGridToolbarTemplate>
              <div class="row pull-right">
                <app-accounting-document-grid-btn [title]=titleBtnGrid
                  [advancedAdd]='fiscalYearIsOpened && this.authService.hasAuthority(AccountingPermissions.ADD_DOCUMENTS_ACCOUNTS)'
                  [export]='this.authService.hasAuthority(AccountingPermissions.EXPORT_DOCUMENTS_ACCOUNTS)'
                  [canExportModel]='this.authService.hasAuthority(AccountingPermissions.EXPORT_MODEL_DOCUMENTS_ACCOUNTS)'
                  [canImport]='fiscalYearIsOpened && this.authService.hasAuthority(AccountingPermissions.IMPORT_DOCUMENTS_ACCOUNTS)' [addLink]='"add"'
                  [openAddDocumentAccountInNewTab]='this.authService.hasAuthority(AccountingPermissions.ADD_DOCUMENTS_ACCOUNTS) && openAddDocumentAccountInNewTab()'
                  style="margin-top: -5%; display: inline-flex;"></app-accounting-document-grid-btn>
              </div>
            </ng-template>
            <!--End Grid toolbar-->

            <kendo-grid-column [width]="110" [field]="gridSettings.columnsConfig[0].field"
              [title]="gridSettings.columnsConfig[0].title | translate" [filter]="gridSettings.columnsConfig[0].filter">

              <ng-template kendoGridHeaderTemplate>
                <span tooltip="{{gridSettings.columnsConfig[0].tooltip|translate}}"
                  theme="light">{{gridSettings.columnsConfig[0].title|translate}}</span>
              </ng-template>

            </kendo-grid-column>

            <kendo-grid-column [width]="300" [field]="gridSettings.columnsConfig[1].field"
              [title]="gridSettings.columnsConfig[1].title | translate" [filter]="gridSettings.columnsConfig[1].filter">

              <ng-template kendoGridHeaderTemplate>
                <span tooltip="{{gridSettings.columnsConfig[1].tooltip|translate}}"
                  theme="light">{{gridSettings.columnsConfig[1].title|translate}}</span>
              </ng-template>

              <ng-template kendoGridCellTemplate let-dataItem>
                <div *ngIf="dataItem.indexOfStatus==getDocumentAccountStatus().BY_IMPORT_DOCUMENT_IS_CREATED"
                  style="color: #00b0ff;text-decoration: underline;cursor: pointer;"
                  (click)="goToBillDocument(dataItem.billId, dataItem.journalLabel)">{{dataItem.label}}</div>
                <div *ngIf="dataItem.indexOfStatus!==getDocumentAccountStatus().BY_IMPORT_DOCUMENT_IS_CREATED">{{dataItem.label}}</div>
              </ng-template>

            </kendo-grid-column>

            <kendo-grid-column [width]="300" [field]="gridSettings.columnsConfig[2].field"
              [title]="gridSettings.columnsConfig[2].title | translate" [filter]="gridSettings.columnsConfig[2].filter">

              <ng-template kendoGridHeaderTemplate>
                <span tooltip="{{gridSettings.columnsConfig[2].tooltip|translate}}"
                  theme="light">{{gridSettings.columnsConfig[2].title|translate}}</span>
              </ng-template>

              <ng-template kendoGridFilterCellTemplate let-filter>
                <kendo-combobox style="width: 200px" [data]="journalFiltredList" [(ngModel)]="selectedJournalInFilter"
                  (filterChange)="handleFilterJournal($event)" [textField]="'label'" [valueField]="'id'"
                  [filterable]="true" (valueChange)="journalValueChange()">
                   <!--No data template-->
              <ng-template kendoDropDownListNoDataTemplate>
                <h5><br/> {{'NO_DATA_FOUND'|translate}}</h5>
              </ng-template>
              <kendo-combobox-messages clearTitle="{{'CLEAR'|translate}}"> </kendo-combobox-messages>
                </kendo-combobox>
              </ng-template>

            </kendo-grid-column>

            <kendo-grid-column [width]="175" [field]="gridSettings.columnsConfig[3].field"
              [title]="gridSettings.columnsConfig[3].title | translate" [filter]="gridSettings.columnsConfig[3].filter">

              <ng-template kendoGridHeaderTemplate>
                <span tooltip="{{gridSettings.columnsConfig[3].tooltip|translate}}"
                  theme="light">{{gridSettings.columnsConfig[3].title|translate}}</span>
              </ng-template>

              <ng-template kendoGridCellTemplate let-dataItem>
                {{dataItem.documentDate | date: formatDate}}
              </ng-template>

            </kendo-grid-column>

            <kendo-grid-column [width]="200" [field]="gridSettings.columnsConfig[4].field"
              [format]="formatNumberOptions" [title]="gridSettings.columnsConfig[4].title | translate"
              [filter]="gridSettings.columnsConfig[4].filter">

              <ng-template kendoGridHeaderTemplate>
                <span tooltip="{{gridSettings.columnsConfig[4].tooltip|translate}}"
                  theme="light">{{gridSettings.columnsConfig[4].title|translate}}</span>
              </ng-template>

              <ng-template kendoGridCellTemplate let-dataItem>
                <kendo-numerictextbox class="text-right" [readonly]="true" [format]="formatNumberOptions"
                  value="{{dataItem.totalDebitAmount}}">
                </kendo-numerictextbox>
              </ng-template>

            </kendo-grid-column>

            <kendo-grid-command-column [width]="150" title="{{'ACTION' | translate}}">
              <ng-template kendoGridCellTemplate let-isNew="isNew" let-dataItem>
                <i class="las fa fa-history cursor-pointer la-lg" aria-hidden="true"
                  (click)="goToHistoric(dataItem)"></i>
                <i class="las la-pen cursor-pointer edit-pencil la-lg mx-3" aria-hidden="true"
                  (click)="goToAdvancedEdit(dataItem)"></i>
                  <i *ngIf="this.authService.hasAuthority(AccountingPermissions.DELETE_DOCUMENTS_ACCOUNTS) &&
                  (dataItem.indexOfStatus!==getDocumentAccountStatus().BY_IMPORT_DOCUMENT_IS_CREATED &&
                  dataItem.indexOfStatus!==getDocumentAccountStatus().BY_CONCLUDING_CURRENT_FISCAL_YEAR_IS_CREATED &&
                 dataItem.indexOfStatus!==getDocumentAccountStatus().BY_GENERATION_FROM_AMORTIZAION_IS_CREATED 
                  && dataItem.indexOfStatus!==getDocumentAccountStatus().BY_IMPORT_SETTLEMENT_IS_CREATED &&
                  fiscalYearIsOpened) && (closedPeriodEndDate==null ||(dataItem.documentDate | date) > (closedPeriodEndDate |date))"
                  class="las la-trash-alt text-danger cursor-pointer la-lg" aria-hidden="true"
                  (click)="removeHandler(dataItem)"></i>
              </ng-template>
            </kendo-grid-command-column>

            <kendo-grid-messages pagerItems="{{'ELEMENTS_PAGER'|translate}}"
              pagerItemsPerPage="{{'ELEMENTS_PER_PAGE_PAGER'|translate}} - {{currencyCode}}">
            </kendo-grid-messages>
          </kendo-grid>
        </div>
      </div>
    </div>
  </div>
</div>
